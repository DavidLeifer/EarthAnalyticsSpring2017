---
title: "week3"
author: "david"
date: "March 17, 2017"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction to DSM

LiDAR or Light Detection and Ranging- active remote sensing system because the system itself measures the time it takes for emitted light to travel to the ground and back.

The distribution of energy creates a waveform, where the amount of returned energy is known as the intensity.

Common uses for LiDAR include:

-topographic maps

-vegetation structure

### Discrete vs. Full Waveform LiDAR

1.) Discrete Return LiDAR records individual points from the peaks in the waveform curve (usually 1-4).

2.) Full Waveform LiDAR System records a distribution of returned energy.

LiDAR is usually recorded in .las or .laz files. Metadata tells alot about how and where the data was collected. Classified data will tag the type of object the light reflects off of. Some classified data can be vegetation or ground.

### Raster data types

Although point clouds give alot of information, they are large and sometimes cumbersome to work with. A raster file composed of a regular grid of pixel cells allows the user to navigate the terrain easier. A 1 meter resoultion raster means that each pixel represents a 1m by 1m area on the ground.

Rasters are derived from a number of methods:

1.) A grid is placed on top of the LiDAR in space and each cell  in the grid gets some points to tell it what it will be classified as.

2.) Interpolation considers the values of points outside the cell in addition to inside the cell.

```{r cars}
library(raster)
library(rgdal)

setwd("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/")

# open raster data
lidar_dem <- raster(x="/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill/pre-flood/lidar/pre_DTM.tif")

# plot raster data
plot(lidar_dem,
     main="Digital Elevation Model - Pre 2013 Flood")

# zoom in to one region of the raster
plot(lidar_dem,
  xlim=c(473000, 473030), # define the x limits
  ylim=c(4434000, 4434030), # define y limits for the plot
     main="Lidar Raster - Zoomed into to one small region")

#return information
xres(lidar_dem)
yres(lidar_dem)
crs(lidar_dem)

# plot histogram
hist(lidar_dem,
     main="Distribution of surface elevation values",
     xlab="Elevation (meters)", ylab="Frequency",
     col="springgreen")
```

## CHM, DSM, DEM

3 of the most common derived data products are:

1.) Digital Terrain Model- ground elevation. These do not include trees and other objects (DEM).

2.) Digital Surface Model- top of the surface.

3.) Canopy Height Model- elevation of the Earth's surface. This is the DSM- DEM.

```{r DSM}
library(raster)
library(rgdal)

setwd("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/")

# open raster data
lidar_dem <- raster(x="/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill/pre-flood/lidar/pre_DTM.tif")

# plot raster data
plot(lidar_dem,
     main="Lidar Digital Elevation Model (DEM)")

# open raster data
lidar_dsm <- raster(x="/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill/pre-flood/lidar/pre_DSM.tif")

# plot raster data
plot(lidar_dsm,
     main="Lidar Digital Surface Model (DSM)")

# open raster data
lidar_chm <- lidar_dsm - lidar_dem

# plot raster data
plot(lidar_chm,
     main="Lidar Canopy Height Model (CHM)")

# plot raster data
plot(lidar_chm,
     breaks = c(0, 2, 10, 20, 30),
     main="Lidar Canopy Height Model",
     col=c("white","brown","springgreen","darkgreen"))

# check to see if an output directory exists
dir.exists("/week3/data/outputs")

## [1] TRUE

# if the output directory doesn't exist, create it
if (dir.exists("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/outputs")) {
  print("the directory exists!")
  } else {
    # if the directory doesn't exist, create it
    # recursive tells R to create the entire directory path (data/week3/outputs)
    dir.create("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/outputs", recursive=TRUE)
  }
## [1] "the directory exists!"

# export CHM object to new GeotIFF
writeRaster(lidar_chm, "/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/outputs/lidar_chm.tiff",
            format="GTiff",  # output format = GeoTIFF
            overwrite=TRUE) # CAUTION: if this is true, it will overwrite an existing file

#CHALLENGE: subtract pre from post DEM
#pre
pre_dsm <- raster(x="/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill/pre-flood/lidar/pre_DSM.tif")

#post
post_dsm <- raster(x="/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill/post-flood/lidar/post_DSM.tif")

sub <- pre_dsm - post_dsm

plot(sub,
     main="Cut and Fill Analysis DEM")

writeRaster(sub, "/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/outputs/DEM_sub.tiff",
            format="GTiff",  # output format = GeoTIFF
            overwrite=TRUE) 
```

## Classify a Raster

```{r classify a raster}
library(raster)
library(rgdal)

# create classification matrix
reclass_df <- c(0, 10, 1,
             10, 20, 2,
             20, 35, 3)
reclass_df
## [1]  0 10  1 10 20  2 20 35  3

# reshape the object into a matrix with columns and rows
reclass_m <- matrix(reclass_df,
                ncol=3,
                byrow=TRUE)
reclass_m

# open canopy height model
lidar_chm <- raster("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/outputs/lidar_chm.tif")

# reclassify the raster using the reclass object - reclass_m
chm_classified <- reclassify(lidar_chm,
                     reclass_m)
# plot reclassified data
plot(chm_classified,
     col=c("red", "blue", "green"))

# plot reclassified data
plot(chm_classified,
     legend=F,
     col=c("red", "blue", "green"), axes=F,
     main="Canopy Height Model - Classified")

legend("right",
       legend = c("short trees", "medium trees", "tall trees"),
       fill = c("red", "blue", "green"),
       border = F,
       bty="n") # turn off legend border
```

## Crop a Raster with a Shapefile

```{r crop a raster with a shapefile}
library(raster)
library(rgdal)

lidar_chm <- raster("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/outputs/lidar_chm.tif")

# plot CHM
plot(lidar_chm,
     col=rev(terrain.colors(50)))

# import the vector boundary
crop_extent <- readOGR("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill",
                       "clip-extent")
## OGR data source with driver: ESRI Shapefile 
## Source: "data/week3/BLDR_LeeHill", layer: "clip-extent"
## with 1 features
## It has 1 fields
## Integer64 fields read as strings:  id

# plot imported shapefile
# notice that we use add=T to add a layer on top of an existing plot in R.
plot(crop_extent,
     main="Shapefile imported into R - crop extent",
     axes=T,
     border="blue")

# crop the lidar raster using the vector extent
lidar_chm_crop <- crop(lidar_chm, crop_extent)
plot(lidar_chm_crop, main="Cropped lidar chm")

# add shapefile on top of the existing raster
plot(crop_extent, add=T)
```

### Create a Basemap

```{r words}
library(ggmap)

myMap <- get_map(location = "Boulder, Colorado",
          source="google",
          maptype="terrain", crop=FALSE,
          zoom=6)
## Source : https://maps.googleapis.com/maps/api/staticmap?center=Boulder,+Colorado&zoom=6&size=640x640&scale=2&maptype=terrain&language=en-EN
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=Boulder%2C%20Colorado
# plot map
ggmap(myMap)

# add points to your map
# creating a sample data.frame with your lat/lon points
lon <- c(-105.178333)
lat <- c(40.051667)
df <- as.data.frame(cbind(lon,lat))

# create a map with a point location for boulder.
ggmap(myMap) + labs(x = "", y = "") +
  geom_point(data = df, aes(x = lon, y = lat, fill = "red", alpha = 0.2), size = 5, shape = 19) +
  guides(fill=FALSE, alpha=FALSE, size=FALSE)

#alt maps
library(maps)

map('state')
# add a title to your map
title('Map of the United States')

map('state', col="darkgray", fill=TRUE, border="white")
# add a title to your map
title('Map of the United States')

map('county', regions="Colorado", col="darkgray", fill=TRUE, border="grey80")
map('state', regions="Colorado", col="black", add=T)
# add the x, y location of the stream guage using the points 
# notice i used two colors adn sized to may the symbol look a little brighter
points(x=-105.178333, y=40.051667, pch=21, col="violetred4", cex=2)
points(x=-105.178333, y=40.051667, pch=8, col="white", cex=1.3)
# add a title to your map
title('County Map of Colorado\nStream gage location')


map('state', fill=TRUE, col="darkgray", border="white", lwd=1)
map(database = "usa", lwd=1, add=T)
# add the adjacent parts of the US; can't forget my homeland
map("state","colorado", col="springgreen", 
    lwd=1, fill=TRUE, add=TRUE)  
# add gage location
title("Stream gage location\nBoulder, Colorado")
# add the x, y location of hte stream guage using the points 
points(x=-105.178333, y=40.051667, pch=8, col="red", cex=1.3)

```

### Basemaps from ggmap

```{r more words}

library(raster)
library(rgdal)

# open raster DTM data
lidar_dem <- raster(x="/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill/pre-flood/lidar/pre_DTM.tif")

# open dem hillshade
lidar_dem_hill <- raster(x="/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill/pre-flood/lidar/pre_DTM_hill.tif")

# plot raster data
plot(lidar_dem_hill,
     main="Lidar Digital Elevation Model (DEM)\n overlayed on top of a hillshade",
     col=grey(1:100/100),
     legend=F)

plot(lidar_dem,
     main="Lidar Digital Elevation Model (DEM)",
     add=T, alpha=.5)

```

### Raster Analysis Workflow in R

```{r}
# load libraries
library(raster)
library(rgdal)
## rgdal: version: 1.2-5, (SVN revision 648)
##  Geospatial Data Abstraction Library extensions to R successfully loaded
##  Loaded GDAL runtime: GDAL 2.1.2, released 2016/10/24
##  Path to GDAL shared files: /Users/lewa8222/Library/R/3.3/library/rgdal/gdal
##  Loaded PROJ.4 runtime: Rel. 4.9.1, 04 March 2015, [PJ_VERSION: 491]
##  Path to PROJ.4 shared files: /Users/lewa8222/Library/R/3.3/library/rgdal/proj
##  Linking to sp version: 1.2-4
library(ggplot2)

options(stringsAsFactors = F)

# load data
pre_dtm <- raster("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill/pre-flood/lidar/pre_DTM.tif")
pre_dsm <- raster("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill/pre-flood/lidar/pre_DSM.tif")

post_dtm <- raster("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill/post-flood/lidar/post_DTM.tif")
post_dsm <- raster("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill/post-flood/lidar/post_DSM.tif")

# import crop extent
crop_ext <- readOGR("/tmp/guest-hbcurl/EarthAnalyticsSpring2017/week3/data/BLDR_LeeHill", "clip-extent")

dtm_diff_uncropped <- post_dtm - pre_dtm
plot(dtm_diff_uncropped)

# crop the data
dtm_diff <- crop(dtm_diff_uncropped, crop_ext)
plot(dtm_diff,
     main="cropped data")

hist(dtm_diff,
     main="Distribution of raster cell values in the DTM difference data",
     xlab="Height (m)", ylab="Number of Pixels",
     col="springgreen")

hist(dtm_diff,
     xlim=c(-2,2),
     main="Histogram of pre-post flood DTM differences \nZoomed in to -2 to 2 on the x axis",
     col="brown")

histinfo <- hist(dtm_diff)

hist(dtm_diff,
     xlim=c(-2,2),
     breaks=500,
     main="Histogram \n Zoomed in to -2-2 on the x axis w more breaks",
     xlab="Height (m)", ylab="Number of Pixels",
     col="springgreen")

hist(dtm_diff,
     breaks=c(-20, -10, -3, -.3, .3, 3, 10, 50),
     main="Histogram with custom breaks",
     xlab="Height (m)" , ylab="Number of Pixels",
     col="springgreen")

# plot dtm difference with breaks
plot(dtm_diff,
     breaks=c(-20, -10, -3, -.3, .3, 3, 10, 50),
     col=terrain.colors(7),
     main="DTM Difference \n Using manual breaks")

diff_colors <- c("palevioletred4", "palevioletred2", "palevioletred1", "ivory1",
                "seagreen1","seagreen2","seagreen4")
plot(dtm_diff,
     breaks=c(-20, -3, -.3, .3, 3, 50),
     col=diff_colors,
     legend=F,
     main="Plot of DTM differences\n custom colors & manual breaks")

par(xpd=T)
# add the legend to the plot
legend(x=dtm_diff@extent@xmax, y=dtm_diff@extent@ymax, # legend location
       legend=c("-20 to -3", "-3 to -.3",
                "-.3 to .3", ".3 to 3", "3 to 50"),
       fill=diff_colors,
       bty="n",
       cex=.7)

# new_extent <- drawExtent()
new_extent <- extent(473690, 474155.2, 4434849, 4435204)
new_extent
## class       : Extent 
## xmin        : 473690 
## xmax        : 474155.2 
## ymin        : 4434849 
## ymax        : 4435204

# crop the raster to a smaller area
dtm_diff_crop <- crop(dtm_diff, new_extent)

# Plot the cropped raster
plot(dtm_diff_crop,
     breaks=c(-20, -3, -.3, .3, 3, 50),
     col=diff_colors,
     legend=F,
     main="Lidar DTM Difference \n cropped subset")

# grab the upper right hand corner coordinates to place the legend.
legendx <- dtm_diff_crop@extent@xmax
legendy <- dtm_diff_crop@extent@ymax

par(xpd=TRUE)
legend(legendx, legendy,
       legend=c("-20 to -3", "-3 to -.3", "-.3 to .3",
                ".3 to 3", "3 to 50"),
       fill=diff_colors,
       bty="n",
       cex=.8)

# create reclass vector
reclass_vector <- c(-20,-3, -2,
                    -3, -.5, -1,
                    -.5, .5, 0,
                    .5, 3, 1,
                    3, 50, 2)

reclass_matrix <- matrix(reclass_vector,
                         ncol=3,
                         byrow = T)

diff_dtm_rcl <- reclassify(dtm_diff, reclass_matrix)

plot(diff_dtm_rcl,
     col=diff_colors,
     legend=F,
     main="Reclassified, Cropped Difference DTM \n difference in meters")
par(xpd=T)
legend(dtm_diff@extent@xmax, dtm_diff@extent@ymax,
       legend=c("-20 to -10", "-10 to -3", "-3 to -.5",
                "-.5 to .5", "1 to 3", "3 to 10", "10 to 50"),
       fill=diff_colors,
       bty="n",
       cex=.8)

hist(diff_dtm_rcl,
     main="Histogram of reclassified data",
     xlab="Height Class (meters)",
     ylab="Number of Pixels")

barplot(diff_dtm_rcl,
     main="Barplot of reclassified data",
     xlab="Height Class (meters)",
     ylab="Frequency of Pixels",
     col=diff_colors)
## Warning in .local(height, ...): a sample of 14.3% of the raster cells were
## used to estimate frequencies

# create a new raster object
diff_dtm_rcl_na <- diff_dtm_rcl
# assign values between -.5 and .5 to NA
diff_dtm_rcl_na[diff_dtm_rcl_na >= -.5 & diff_dtm_rcl_na <= .5] <- NA
# view histogram
barplot(diff_dtm_rcl_na,
     main="Histogram of data \n values between -.5 and .5 set to NA",
     xlab="Difference Class",
     col=diff_colors)
## Warning in .local(height, ...): a sample of 14.3% of the raster cells were
## used to estimate frequencies

summary(diff_dtm_rcl_na)

```
